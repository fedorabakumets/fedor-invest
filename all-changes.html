<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Последние изменения</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: Arial, sans-serif; background: #f5f5f5; padding: 20px; color: #333; }
        .container { max-width: 600px; margin: 0 auto; }
        h1 { text-align: center; margin-bottom: 30px; color: #0066cc; }
        .controls { margin-bottom: 20px; display: flex; gap: 10px; flex-wrap: wrap; }
        input, select { padding: 8px 12px; border: 1px solid #ccc; border-radius: 5px; font-size: 14px; }
        input { flex: 1; min-width: 200px; }
        button { padding: 8px 16px; background: #0066cc; color: white; border: none; border-radius: 5px; cursor: pointer; }
        button:hover { background: #0052a3; }
        .changes-list { display: flex; flex-direction: column; gap: 12px; }
        .change-item { background: white; padding: 12px; border-radius: 5px; border-left: 4px solid #0066cc; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .change-item.added { border-left-color: #27ae60; }
        .site-name { font-weight: bold; color: #0066cc; }
        .date { color: #666; font-size: 12px; }
        .load-more { display: block; margin: 20px auto; padding: 10px 20px; }
        .empty { text-align: center; color: #999; padding: 40px 20px; }
        .loading { text-align: center; color: #0066cc; padding: 20px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Последние изменения</h1>
        
        <div class="controls">
            <input type="text" id="search" placeholder="Поиск по названию сайта">
            <select id="sort">
                <option value="new">Новые первыми</option>
                <option value="old">Старые первыми</option>
                <option value="name">По названию (А-Я)</option>
            </select>
            <button onclick="location.reload()">Обновить</button>
        </div>

        <div id="changes" class="changes-list"></div>
        <button id="loadMore" class="load-more" onclick="loadMore()" style="display:none">Загрузить ещё</button>
    </div>

    <script>
        let allChanges = [];
        let filteredChanges = [];
        let currentPage = 1;
        const itemsPerPage = 5;

        const DEMO = [
            { date: '2025-11-29', site: 'unknown сайт', change: 'сайт был добавлен', old: '', new: 'https://unknown.ru' },
            { date: '2025-11-28', site: 'neobux', change: 'минимальная сумма вывода', old: '0.01', new: '0.02' },
            { date: '2025-11-27', site: 'clixsense', change: 'сложность регистрации', old: 'Средняя', new: 'Легкая' },
            { date: '2025-11-26', site: 'prizerebel', change: 'платежные системы', old: 'PayPal', new: 'PayPal, Amazon' },
            { date: '2025-11-25', site: 'swagbucks', change: 'год создания', old: '2009', new: '2010' }
        ];

        function escape(t) {
            const m = {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'};
            return t.replace(/[&<>"']/g, c => m[c]);
        }

        function render() {
            const c = document.getElementById('changes');
            c.innerHTML = '';
            if (!filteredChanges.length) {
                c.innerHTML = '<div class="empty">Нет изменений</div>';
                document.getElementById('loadMore').style.display = 'none';
                return;
            }
            const s = (currentPage-1) * itemsPerPage;
            const e = s + itemsPerPage;
            const show = filteredChanges.slice(s, e);
            show.forEach(ch => {
                const d = document.createElement('div');
                d.className = 'change-item' + (ch.change.includes('добавлен') ? ' added' : '');
                let h = `На сайте <span class="site-name">${escape(ch.site)}</span> ${escape(ch.change)} `;
                if (ch.old) h += `с <span style="color:#999">${escape(ch.old)}</span> `;
                if (ch.old || ch.new) h += `на `;
                if (ch.new) h += `<span style="color:#27ae60;font-weight:bold">${escape(ch.new)}</span> `;
                h += `<div class="date">${ch.date}</div>`;
                d.innerHTML = h;
                c.appendChild(d);
            });
            document.getElementById('loadMore').style.display = e < filteredChanges.length ? 'block' : 'none';
        }

        function filter() {
            const q = document.getElementById('search').value.toLowerCase();
            const s = document.getElementById('sort').value;
            filteredChanges = allChanges.filter(x => x.site.toLowerCase().includes(q));
            if (s === 'new') filteredChanges.sort((a,b) => new Date(b.date) - new Date(a.date));
            else if (s === 'old') filteredChanges.sort((a,b) => new Date(a.date) - new Date(b.date));
            else if (s === 'name') filteredChanges.sort((a,b) => a.site.localeCompare(b.site, 'ru'));
            currentPage = 1;
            render();
        }

        async function load() {
            document.getElementById('changes').innerHTML = '<div class="loading">Загрузка...</div>';
            try {
                const r = await fetch('/api/changes', {cache: 'no-store'});
                const d = await r.json();
                allChanges = (d && d.length) ? d : DEMO;
            } catch(e) {
                console.log('Используем демо-данные:', e);
                allChanges = DEMO;
            }
            filter();
        }

        function loadMore() {
            currentPage++;
            render();
        }

        document.getElementById('search').addEventListener('input', filter);
        document.getElementById('sort').addEventListener('change', filter);
        load();
    </script>
</body>
</html>