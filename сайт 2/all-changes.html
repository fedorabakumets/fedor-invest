<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Последние изменения</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: Arial, sans-serif; background: #f5f5f5; padding: 20px; color: #333; }
        .container { max-width: 600px; margin: 0 auto; }
        h1 { text-align: center; margin-bottom: 30px; color: #0066cc; }
        .controls { margin-bottom: 20px; display: flex; gap: 10px; flex-wrap: wrap; }
        input, select { padding: 8px 12px; border: 1px solid #ccc; border-radius: 5px; font-size: 14px; }
        input { flex: 1; min-width: 200px; }
        button { padding: 8px 16px; background: #0066cc; color: white; border: none; border-radius: 5px; cursor: pointer; }
        button:hover { background: #0052a3; }
        .changes-list { display: flex; flex-direction: column; gap: 12px; }
        .change-item { background: white; padding: 12px; border-radius: 5px; border-left: 4px solid #0066cc; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .change-item.added { border-left-color: #27ae60; }
        .site-name { font-weight: bold; color: #0066cc; }
        .old-val { color: #999; text-decoration: line-through; }
        .new-val { color: #27ae60; font-weight: bold; }
        .date { color: #666; font-size: 12px; }
        .load-more { display: block; margin: 20px auto; padding: 10px 20px; }
        .empty { text-align: center; color: #999; padding: 40px 20px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Последние изменения</h1>
        
        <div class="controls">
            <input type="text" id="search" placeholder="Поиск по названию сайта">
            <select id="sort">
                <option value="new">Новые первыми</option>
                <option value="old">Старые первыми</option>
                <option value="name">По названию (А-Я)</option>
            </select>
            <button onclick="refresh()">Обновить</button>
        </div>

        <div id="changes" class="changes-list"></div>
        <button id="loadMore" class="load-more" onclick="loadMore()" style="display:none">Загрузить ещё</button>
    </div>

    <script>
        const DEMO_DATA = [
            { date: '2025-11-29', site: 'unknown сайт', change: 'сайт был добавлен', old: '', new: 'https://unknown.ru' },
            { date: '2025-11-28', site: 'neobux', change: 'минимальная сумма вывода', old: '0.01', new: '0.02' },
            { date: '2025-11-27', site: 'clixsense', change: 'сложность регистрации', old: 'Средняя', new: 'Легкая' },
            { date: '2025-11-26', site: 'prizerebel', change: 'платежные системы', old: 'PayPal', new: 'PayPal, Amazon' },
            { date: '2025-11-25', site: 'swagbucks', change: 'год создания', old: '2009', new: '2010' },
            { date: '2025-11-24', site: 'clicksold', change: 'минимальная сумма вывода', old: '5', new: '3' },
            { date: '2025-11-23', site: 'adnow', change: 'платежные системы', old: 'WebMoney', new: 'WebMoney, Yandex' },
            { date: '2025-11-22', site: 'climbpay', change: 'сложность регистрации', old: 'Сложная', new: 'Средняя' },
        ];

        async function loadGoogleSheets() {
            try {
                const response = await fetch('/api/changes');
                if (!response.ok) throw new Error('Ошибка загрузки');
                const data = await response.json();
                return data.length > 0 ? data : DEMO_DATA;
            } catch (e) {
                console.log('Google Sheets недоступна, используем демо:', e.message);
                return DEMO_DATA;
            }
        }

        let allChanges = DEMO_DATA;
        let filteredChanges = DEMO_DATA;
        let currentPage = 1;
        const itemsPerPage = 5;

        function escape(text) {
            const map = { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;' };
            return text.replace(/[&<>"']/g, m => map[m]);
        }

        function render() {
            const container = document.getElementById('changes');
            container.innerHTML = '';

            if (filteredChanges.length === 0) {
                container.innerHTML = '<div class="empty">Нет изменений</div>';
                document.getElementById('loadMore').style.display = 'none';
                return;
            }

            const start = 0;
            const end = currentPage * itemsPerPage;
            const toShow = filteredChanges.slice(start, end);

            toShow.forEach(change => {
                const div = document.createElement('div');
                div.className = 'change-item' + (change.change.includes('добавлен') ? ' added' : '');
                let html = `На сайте <span class="site-name">${escape(change.site)}</span> ${escape(change.change)} `;
                if (change.old) html += `с <span class="old-val">${escape(change.old)}</span> `;
                if (change.old || change.new) html += `на `;
                if (change.new) html += `<span class="new-val">${escape(change.new)}</span> `;
                html += `<div class="date">${change.date}</div>`;
                div.innerHTML = html;
                container.appendChild(div);
            });

            document.getElementById('loadMore').style.display = end < filteredChanges.length ? 'block' : 'none';
        }

        function filter() {
            const search = document.getElementById('search').value.toLowerCase();
            const sort = document.getElementById('sort').value;

            filteredChanges = allChanges.filter(c => c.site.toLowerCase().includes(search));

            if (sort === 'new') filteredChanges.sort((a, b) => new Date(b.date) - new Date(a.date));
            else if (sort === 'old') filteredChanges.sort((a, b) => new Date(a.date) - new Date(b.date));
            else if (sort === 'name') filteredChanges.sort((a, b) => a.site.localeCompare(b.site, 'ru'));

            currentPage = 1;
            render();
        }

        function loadMore() {
            currentPage++;
            render();
        }

        function refresh() {
            // Демо - просто перезагружаем
            filter();
        }

        document.getElementById('search').addEventListener('input', filter);
        document.getElementById('sort').addEventListener('change', filter);

        (async () => {
            allChanges = await loadGoogleSheets();
            filteredChanges = allChanges;
            filter();
        })();
    </script>
</body>
</html>